#INCLUDE "wsmat150.ch"
#INCLUDE "APWEBSRV.CH"
#INCLUDE "PROTHEUS.CH"
/*/


Ŀ
Funo    WSMAT150   Autor Eduardo Riera           Data 08.08.2003  
Ĵ
Descrio  Web Service responsavel pelas cotacoes do sistema            
                                                                        
Ĵ
Sintaxe                                                                 
Ĵ
Parametros                                                              
Ĵ
Uso        CRM/Materiais/Portais                                        
Ĵ
 Atualizacoes sofridas desde a Construcao Inicial.                       
Ĵ
 Programador   Data    BOPS   Motivo da Alteracao                     
Ĵ
                                                                      
ٱ


/*/
//Ŀ
//Definicao do Web Service de Controle do Usuario                         
//
WSSERVICE MtSupplierQuote          DESCRIPTION STR0001 NAMESPACE "http://webservices.microsiga.com.br/mtsupplierquote.apw" //"Servio de consulta e atualizao das cotaes de compras ( <b>Restrio de fornecedor</b> )"
   WSDATA HeaderType               AS String
   WSDATA Header                   AS Array Of BrwHeader
   WSDATA UserCode                 AS String
   WSDATA QuoteHeader              AS Array Of QuoteHeaderView
   WSDATA ExpiryDateFrom           As Date OPTIONAL
   WSDATA ExpiryDateTo             As Date OPTIONAL
   WSDATA Supplier                 As String
   WSDATA QuoteID                  As String
   WSDATA Quote                    AS QuoteView
   WSDATA Quotes                   As Array of QuoteView
   WSDATA WsNull                   AS Integer
   WSDATA QueryAddWhere            AS String

   WSMETHOD GetHeader     DESCRIPTION STR0002 //"Mtodo que descreve as estruturas de retorno do servio"
   WSMETHOD BrwQuote      DESCRIPTION STR0003 //"Mtodo de listagem das informaes das cotaes em aberto"
   WSMETHOD GetQuote      DESCRIPTION STR0004 //"Mtodo de consulta das informaes de cotao em aberto"
   WSMETHOD PutQuote      DESCRIPTION STR0005 //"Mtodo de atualizao das informaes de cotao em aberto"
ENDWSSERVICE

/*/

Ŀ
Funo    GetHeader Autor   Eduardo Riera          Data 08.08.2003 
Ĵ
          Rotina de recuperacao do header das cotacoes do sistema      
                                                                       
Ĵ
ParametrosNenhum                                                       
Ĵ
Retorno   ExpL1: Indica que o metodo foi avaliado com sucesso          
                                                                       
Ĵ
Descrio Este metodo devolve o header de uma estrutura                
                                                                       
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
WSMETHOD GetHeader WSRECEIVE HeaderType WSSEND Header WSSERVICE MtSupplierQuote

::Header := MtHeader(::HeaderType)

Return(.T.)

/*/

Ŀ
Funo    BrwQuote  Autor   Eduardo Riera          Data 11.08.2003 
Ĵ
          Rotina de recuperacao das cotacoes do Sistema                
                                                                       
Ĵ
ParametrosExpC1: Codigo do usuario                                     
          ExpC2: Fornecedor                                            
          ExpD3: Data Inicial                                          
          ExpD4: Data Final                                            
Ĵ
Retorno   ExpL1: Indica que o metodo foi avaliado com sucesso          
                                                                       
Ĵ
Descrio Este metodo devolve as cotacaoes em aberto do fornecedor     
                                                                       
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
WSMETHOD BrwQuote WSRECEIVE UserCode,Supplier,ExpiryDateFrom,ExpiryDateTo,QueryAddWhere WSSEND QuoteHeader WSSERVICE MtSupplierQuote

Local aArea    := GetArea()
Local aStru    := dbStruct()
Local lRetorno := .T.
Local lQuery   := .F.
Local nX       := 0
Local cQuery   := ""
Local cAliasSC8:= "SC8"
Local cFornece := SubStr(::Supplier,1,Len(SA2->A2_COD))
Local cLoja    := SubStr(::Supplier,Len(SA2->A2_COD)+1)
Local dDataIni := ::ExpiryDateFrom
Local dDataFim := ::ExpiryDateTo

DEFAULT dDataIni := dDataBase
DEFAULT dDataFim := dDataBase+180

If PrtChkUser(::UserCode,"MtSupplierQuote")
	dbSelectArea("SC8")
	dbSetOrder(2)
	#IFDEF TOP
		lQuery := .T.
		aStru  := SC8->(dbStruct())
		cAliasSC8 := "BrwQuote"

		cQuery := "SELECT * "
		cQuery += "FROM "+RetSqlName("SC8")+" SC8 "
		cQuery += "WHERE SC8.C8_FILIAL='"+xFilial("SC8")+"' AND "
		cQuery += "SC8.C8_FORNECE='"+cFornece+"' AND "
		cQuery += "SC8.C8_LOJA='"+cLoja+"' AND "
		cQuery += "SC8.C8_VALIDA>='"+Dtos(dDataIni)+"' AND "
		cQuery += "SC8.C8_VALIDA<='"+Dtos(dDataFim)+"' AND "
		cQuery += "SC8.D_E_L_E_T_=' ' "
		cQuery := WsQueryAdd(cQuery,::QueryAddWhere)
		cQuery += "ORDER BY "+SqlOrder(SC8->(IndexKey()))

		cQuery := ChangeQuery(cQuery)

		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSC8)

		For nX := 1 To Len(aStru)
			If aStru[nX][2]<>"C"
				TcSetField(cAliasSC8,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
			EndIf
		Next nX
	#ELSE
		MsSeek(xFilial("SC8")+Dtos(dDataIni),.T.)
	#ENDIF
	nX := 0
	::QuoteHeader := {}
	While !Eof() .And. xFilial("SC8") == (cAliasSC8)->C8_FILIAL .And.;
		(cAliasSC8)->C8_VALIDA<=dDataFim
		If cFornece == (cAliasSC8)->C8_FORNECE .And.;
			cLoja == (cAliasSC8)->C8_LOJA

			If aScan(::QuoteHeader,{|x| x:QuoteID == (cAliasSC8)->C8_NUM}) == 0
				aadd(::QuoteHeader,WsClassNew("QuoteHeaderView"))
				nX++

				GetSC8Head(@::QuoteHeader[nX],cAliasSC8)
			ELSE 
				GetSC8Head(@::QuoteHeader[nX],cAliasSC8)			
			EndIf
		EndIf
		dbSelectArea(cAliasSC8)
		dbSkip()
	EndDo
	If lQuery
		dbSelectArea(cAliasSC8)
		dbCloseArea()
		dbSelectArea("SC8")
	EndIf
Else
	lRetorno := .F.
EndIf
RestArea(aArea)
Return(lRetorno)

/*/

Ŀ
Funo    GetQuote  Autor   Eduardo Riera          Data 11.08.2003 
Ĵ
          Rotina de recuperacao das cotacoes do Sistema                
                                                                       
Ĵ
ParametrosExpC1: Codigo do usuario                                     
          ExpC2: Numero da Cotacao                                     
          ExpC3: Fornecedor                                            
                                                                       
Ĵ
Retorno   ExpL1: Indica que o metodo foi avaliado com sucesso          
                                                                       
Ĵ
Descrio Este metodo devolve as cotacaoes em aberto do fornecedor     
                                                                       
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
WSMETHOD GetQuote WSRECEIVE UserCode,QuoteID,Supplier,QueryAddWhere WSSEND Quotes WSSERVICE MtSupplierQuote

Local aArea    := GetArea()
Local aProposta:= {}
Local lRetorno := .T.
Local lQuery   := .F.
Local nX       := 0
Local nY       := 0
Local cAliasSC8:= "SC8"
Local cFornece := SubStr(::Supplier,1,Len(SA2->A2_COD))
Local cLoja    := SubStr(::Supplier,Len(SA2->A2_COD)+1)
#IFDEF TOP
Local aStru    := dbStruct()
Local cQuery   := ""
#ENDIF

If PrtChkUser(::UserCode,"MTSUPPLIERQUOTE","GETQUOTE","SA2",::Supplier)
	dbSelectArea("SC8")
	dbSetOrder(1)
	#IFDEF TOP
		lQuery := .T.
		aStru  := SC8->(dbStruct())
		cAliasSC8 := "BrwQuote"

		cQuery := "SELECT * FROM "+RetSqlName("SC8")+" SC8 "
		cQuery += "WHERE SC8.C8_FILIAL='"+xFilial("SC8")+"' AND "
		cQuery += "SC8.C8_FORNECE='"+cFornece+"' AND "
		cQuery += "SC8.C8_LOJA='"+cLoja+"' AND "
		cQuery += "SC8.C8_NUM='"+::QuoteID+"' AND "
		cQuery += "SC8.D_E_L_E_T_=' ' "
		cQuery := WsQueryAdd(cQuery,::QueryAddWhere)
		cQuery += "ORDER BY "+SqlOrder(SC8->(IndexKey()))

		cQuery := ChangeQuery(cQuery)

		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSC8)

		For nX := 1 To Len(aStru)
			If aStru[nX][2]<>"C"
				TcSetField(cAliasSC8,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
			EndIf
		Next nX
	#ELSE
		MsSeek(xFilial("SC8")+::QuoteID)
	#ENDIF
	While !Eof() .And. xFilial("SC8") == (cAliasSC8)->C8_FILIAL .And.;
		(cAliasSC8)->C8_NUM==::QuoteID
		If cFornece == (cAliasSC8)->C8_FORNECE .And.;
			cLoja == (cAliasSC8)->C8_LOJA
			
			//posiciona a SC8 pelo RECNO para no causar conflito com o campo C8_OBS (memo)
			SC8->(DbGoTo((cAliasSC8)->R_E_C_N_O_))

			nY := aScan(aProposta,(cAliasSC8)->C8_NUMPRO)

			If nY == 0
				aadd(aProposta,(cAliasSC8)->C8_NUMPRO)
				aadd(::Quotes,WsClassNew("QuoteView"))
				nY := Len(aProposta)
				::Quotes[nY]:QuoteHeader := WsClassNew("QuoteHeaderView")
				GetSC8Head(@::Quotes[nY]:QuoteHeader,cAliasSC8)
				DEFAULT ::Quotes[nY]:QuoteItem := {}
			ELSE
				GetSC8Head(@::Quotes[nY]:QuoteHeader,cAliasSC8)
				DEFAULT ::Quotes[nY]:QuoteItem := {}
			EndIf
			nX := Len(::Quotes[nY]:QuoteItem)
			nX++
			aadd(::Quotes[nY]:QuoteItem,WsClassNew("QuoteItemView"))
			GetSC8Item(@::Quotes[nY]:QuoteItem[nX],cAliasSC8)
		EndIf
		dbSelectArea(cAliasSC8)
		dbSkip()
	EndDo
	If lQuery
		dbSelectArea(cAliasSC8)
		dbCloseArea()
	EndIf
	If !Empty(::Quotes)
		If Empty(::Quotes[1]:QuoteItem)
			SetSoapFault("GETQUOTE","Cotacao invalida")
			lRetorno := .F.	
		EndIf
	EndIf
Else
	lRetorno := .F.
EndIf
RestArea(aArea)
Return(lRetorno)

/*/

Ŀ
Funo    PutQuote  Autor   Eduardo Riera          Data 11.08.2003 
Ĵ
          Rotina de recuperacao das cotacoes do Sistema                
                                                                       
Ĵ
ParametrosExpC1: Codigo do usuario                                     
          ExpC2: Fornecedor                                            
          ExpO3: Cotacao                                               
                                                                       
Ĵ
Retorno   ExpL1: Indica que o metodo foi avaliado com sucesso          
                                                                       
Ĵ
Descrio Este metodo devolve as cotacaoes em aberto do fornecedor     
                                                                       
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
WSMETHOD PutQuote WSRECEIVE UserCode,Supplier,Quote WSSEND QuoteID WSSERVICE MtSupplierQuote

Local aArea 	:= GetArea() 
Local aCabec 	:= {}
Local aItens 	:= {}
Local aErro 	:= {}
Local aItensAnt := {}
Local lRetorno	:= .T.
Local lZerou	:= .F.
Local nI 		:= 0
Local cCotacao	:= ::Quote:QuoteHeader:QuoteID
Local cFornece	:= SubStr( ::Supplier, 1, Len( SC8->C8_FORNECE ) )
Local cLoja 	:= SubStr( ::Supplier, Len( SC8->C8_FORNECE ) + 1 )
Local cItem 	:= ::Quote:QuoteItem[1]:SequentialID
Local cProposta	:= ::Quote:QuoteHeader:ProposalID
Local aUsrFields:= ::Quote:QuoteHeader:UserFields
Local cErro    	:= ""
Local nPosCond  := 0
Local cCond		:= ""
Local nPosFil	:= 0
Local nPosVlFr	:= 0
Local nPosTotF	:= 0
Local nX		:= 0
Local nZ		:= 0
Local nPosDesc	:= 0
Local nPosZer	:= 0

PRIVATE lMsErroAuto    := .F.
PRIVATE lAutoErrNoFile := .T.

WsChangeModule( "SIGACOM" )

If PrtChkUser( ::UserCode, "MTSIMULATIONQUOTE", "PUTQUOTE", "SA2", ::Supplier )
	SC8->( DbSetOrder( 1 ) )
	SC8->( MsSeek( xFilial( "SC8" ) + cCotacao + cFornece + cLoja + cItem  ) )

	PutSC8Head( ::Quote:QuoteHeader, @aCabec, ::Quote:QuoteHeader:PaymentPlanCode )
	aCabec := WsAutoOpc( @aCabec, .F. )

	// Valida condio de pagamento com cdigo zero
	nPosCond := aScan(aCabec,{|x| AllTrim(x[1])=="C8_COND"})
	If nPosCond > 0
		cCond := aCabec[nPosCond][2]
		aCabec[nPosCond][2] := PADR(cCond,3)
	Else
		aadd(aCabec,{"C8_COND","",NIL})
	EndIf

	// Valida tamanho do campo filial caso tenha sido aumentado pelo Configurador
	nPosFil := aScan(aCabec,{|x| AllTrim(x[1])=="C8_LOJA"})
	If nPosFil > 0
		aCabec[nPosFil][2] := cLoja
	EndIf

	PutSC8Item( ::Quote:QuoteItem, @aItens )

	aItensAnt := aItens

	For nI := 1 To Len( aItens )
		//Ŀ
		//Grava os campos de usuarios do cabecalho da cotacao tambem no array     
		//aItens pois o MATA150 nao grava campos de Usuario passados no aCabec    
		//pois a tabela SC8 de cotacoes so possuem itens e os campos de cabecalho 
		//sao definidos diretamente no mata150 atravez de variaveis.              
		//
		PutUserFields("SC8", @aUsrFields , aItens[nI] )

		aItens[nI] := WsAutoOpc( @aItens[nI], .T. )

		nPosVlFr := aScan(aItens[nI],{|x| AllTrim(x[1])=="C8_VALFRE"})
		nPosTotF := aScan(aCabec,{|x| AllTrim(x[1])=="C8_TOTFRE"})
		If nPosVlFr > 0 .And. nPosTotF > 0
			aCabec[nPosTotF][2] += aItens[nI][nPosVlFr][2]
		EndIf
	Next nI

	// Verifica se o usuario zerou manualmente a alquota padro do IPI do produto
	For nZ := 1 to Len(aItensAnt)
		lZerou := .F.
	    nPosZer := aScan(aItensAnt[nZ],{|x| x[1] == "MANUAL-IPI"})
		If nPosZer > 0
			lZerou := aItensAnt[nZ][nPosZer][2]
		EndIf
		If lZerou
			Aadd(aItens[nZ],{"C8_BASEIPI",0,Nil})
			Aadd(aItens[nZ],{"C8_ALIIPI" ,0,Nil})
			Aadd(aItens[nZ],{"C8_VALIPI" ,0,Nil})
		EndIf	
	Next nZ
	nPosZer := 0
	// Verifica	 se o usuario zerou manualmente a alquota padro do ICM do produto
	For nZ := 1 to Len(aItensAnt)
		lZerou := .F.
	    nPosZer := aScan(aItensAnt[nZ],{|x| x[1] == "MANUAL-ICM"})
		If nPosZer > 0
			lZerou := aItensAnt[nZ][nPosZer][2]
		EndIf
		If lZerou
			Aadd(aItens[nZ],{"C8_BASEICM",0,Nil})
			Aadd(aItens[nZ],{"C8_PICM" ,0,Nil})
			Aadd(aItens[nZ],{"C8_VALICM" ,0,Nil})
		EndIf	
	Next nZ

	// Caso o usurio tenha zerado o valor do desconto, deve passar zero no array
	For nX := 1 To Len(aItens)
		If (nPosDesc := aScan(aItens[nX],{|x| x[1] == "C8_DESC"})) == 0
			AADD(aItens[nX],{"C8_DESC",0,Nil})
		EndIf
	Next nX

	If SC8->( MsSeek( xFilial( "SC8" ) + cCotacao + cFornece + cLoja + cItem + PadR( cProposta, 2 ) ) )
		Mata150( @aCabec, @aItens, 3 )
	Else
		//Posiciona na cotao do fornecedor e loja
		If SC8->( MsSeek( xFilial( "SC8" ) + cCotacao + cFornece + cLoja ) ) 
			While !SC8->( EOF() ) .AND. SC8->C8_NUM == cCotacao;
				.AND. SC8->C8_FORNECE == cFornece ;
				.AND. SC8->C8_LOJA == cLoja

				cProposta := SC8->C8_NUMPRO

				SC8->( DbSkip() )
			EndDo

			aAdd( aCabec, { "C8_NUMPRO", StrZero( Val( cProposta ) + 1, 2 ), Nil } )

			For nI := 1 To Len( aItens )
				aAdd( aItens[nI], { "C8_NUMPRO", StrZero( Val( cProposta ) + 1, 2 ), Nil } )
			Next nI

			Mata150( @aCabec, @aItens, 4 )
		EndIf
	EndIf

	::QuoteID := cCotacao

	If lMsErroAuto
		aErro := GetAutoGRLog()
		cErro := ""
		For nI := 1 To Len( aErro )
			cErro += aErro[nI] + Chr( 13 ) + Chr( 10 )
		Next nI

		SetSoapFault( "PUTQUOTE", cErro )
		lRetorno := .F.
	EndIf
Else
	lRetorno := .F.
EndIf

RestArea( aArea )

Return( lRetorno )

/*/


Ŀ
Funo    WSMAT150   Autor Eduardo Riera           Data 08.08.2003  
Ĵ
Descrio  Web Service responsavel pelas simulacoes de cotacao          
                                                                        
Ĵ
Sintaxe                                                                 
Ĵ
Parametros                                                              
Ĵ
Uso        CRM/Materiais/Portais                                        
Ĵ
 Atualizacoes sofridas desde a Construcao Inicial.                       
Ĵ
 Programador   Data    BOPS   Motivo da Alteracao                     
Ĵ
                                                                      
ٱ


/*/
//Ŀ
//Definicao do Web Service de Controle do Usuario                         
//
WSSERVICE MtSimulationQuote        DESCRIPTION STR0006 NAMESPACE "http://webservices.microsiga.com.br/mtsimulationquote.apw" //"Servio de simulao da atualizao das cotaes de compra <br><br><i>Este servio pode ser utilizado para recuperar o preenchimento automtico de algumas informaes da cotaes de compra, como por exemplo: o calculo dos impostos. Salientamos que este servio executa as customizao presentes no sistema, possibilitando seu uso.</i>"
   WSDATA UserCode                 As String
   WSDATA QuoteHeader              AS Array Of QuoteHeaderView
   WSDATA Supplier                 As String
   WSDATA OldQuote                 As QuoteView
   WSDATA NewQuote                 As QuoteView

   WSMETHOD PutQuote   DESCRIPTION STR0007 //"Mtodo de simulao da atualizao da cotao de compra"
ENDWSSERVICE

/*/

Ŀ
Funo    PutQuote  Autor   Eduardo Riera          Data 11.08.2003 
Ĵ
          Rotina de simulacao da atualizacao das cotacoes do sistema   
                                                                       
Ĵ
ParametrosExpC1: Codigo do usuario                                     
          ExpC2: Fornecedor                                            
          ExpO3: Cotacao                                               
                                                                       
Ĵ
Retorno   ExpL1: Indica que o metodo foi avaliado com sucesso          
                                                                       
Ĵ
Descrio Este metodo simula a atualizacao de um cotacao               
                                                                       
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
WSMETHOD PutQuote WSRECEIVE UserCode,Supplier,OldQuote WSSEND NewQuote WSSERVICE MtSimulationQuote

Local aArea 	:= GetArea()
Local aCabec 	:= {}
Local aItens 	:= {}
Local aErro 	:= {}
Local lRetorno	:= .T.
Local nI 		:= 0
Local cCotacao	:= ::OldQuote:QuoteHeader:QuoteID
Local cFornece	:= SubStr( ::Supplier, 1, Len( SC8->C8_FORNECE ) )
Local cLoja 	:= SubStr( ::Supplier, Len( SC8->C8_FORNECE ) + 1 )
Local cItem 	:= ::OldQuote:QuoteItem[1]:SequentialID
Local cProposta	:= ::OldQuote:QuoteHeader:ProposalID
Local cErro    	:= ""
Local nPosZer	:= 0
Local lZerou	:= .F.
Local aItensAnt := {}
Local nZ		:= 0
Local nPosCond  := 0
Local cCond		:= ""
Local nPosFil	:= 0
Local nPosVlFr	:= 0
Local nPosTotF	:= 0
Local nX		:= 0
Local nPosDesc	:= 0

PRIVATE lMsErroAuto    := .F.
PRIVATE lAutoErrNoFile := .T.

WsChangeModule( "SIGACOM" )

If PrtChkUser( ::UserCode, "MTSIMULATIONQUOTE", "PUTQUOTE", "SA2", ::Supplier )
	SC8->( DbSetOrder( 1 ) )
	SC8->( MsSeek( xFilial( "SC8" ) + cCotacao + cFornece + cLoja + cItem  ) )

	PutSC8Head( ::OldQuote:QuoteHeader, @aCabec, ::OldQuote:QuoteHeader:PaymentPlanCode )
	aCabec := WsAutoOpc( @aCabec, .F. )

	// Valida condio de pagamento com cdigo zero
	nPosCond := aScan(aCabec,{|x| AllTrim(x[1])=="C8_COND"})
	If nPosCond > 0
		cCond := aCabec[nPosCond][2]
		aCabec[nPosCond][2] := PADR(cCond,3)
	Else
		aadd(aCabec,{"C8_COND","",NIL})
	EndIf

	// Valida tamanho do campo filial caso tenha sido aumentado pelo Configurador
	nPosFil := aScan(aCabec,{|x| AllTrim(x[1])=="C8_LOJA"})
	If nPosFil > 0
		aCabec[nPosFil][2] := cLoja
	EndIf

	PutSC8Item( ::OldQuote:QuoteItem, @aItens )

	aItensAnt := aItens

	For nI := 1 To Len( aItens )
		aItens[nI] := WsAutoOpc( @aItens[nI], .T. )

		nPosVlFr := aScan(aItens[nI],{|x| AllTrim(x[1])=="C8_VALFRE"})
		nPosTotF := aScan(aCabec,{|x| AllTrim(x[1])=="C8_TOTFRE"})
		If nPosVlFr > 0 .And. nPosTotF > 0
			aCabec[nPosTotF][2] += aItens[nI][nPosVlFr][2]		
		EndIF
	Next nI

	// Verifica se o usuario zerou manualmente a alquota padro do IPI do produto
	For nZ := 1 to Len(aItensAnt)
		lZerou := .F.
	    nPosZer := aScan(aItensAnt[nZ],{|x| x[1] == "MANUAL-IPI"})
		If nPosZer > 0
			lZerou := aItensAnt[nZ][nPosZer][2]
		EndIf
		If lZerou
			Aadd(aItens[nZ],{"C8_BASEIPI",0,Nil})
			Aadd(aItens[nZ],{"C8_ALIIPI" ,0,Nil})
			Aadd(aItens[nZ],{"C8_VALIPI" ,0,Nil})			
		EndIf	
	Next nZ
	nPosZer := 0
	For nZ := 1 to Len(aItensAnt)
		lZerou := .F.
	    nPosZer := aScan(aItensAnt[nZ],{|x| x[1] == "MANUAL-ICM"})
		If nPosZer > 0
			lZerou := aItensAnt[nZ][nPosZer][2]
		EndIf
		If lZerou			
			Aadd(aItens[nZ],{"C8_BASEICM",0,Nil})
			Aadd(aItens[nZ],{"C8_PICM" ,0,Nil})
			Aadd(aItens[nZ],{"C8_VALICM" ,0,Nil})
			
		EndIf	
	Next nZ

	// Caso o usurio tenha zerado o valor do desconto, deve passar zero no array
	For nX := 1 To Len(aItens)
		If (nPosDesc := aScan(aItens[nX],{|x| x[1] == "C8_DESC"})) == 0
			AADD(aItens[nX],{"C8_DESC",0,Nil}) 
		EndIf
	Next nX

	//nao envia o C8_TOTAL no Array para que a rotina automatica calcule o 
	//C8_TOTAL e em seguida retorne para o acols 
	aItensNew:=Aclone(aItens)
	For nI:=1 to Len(aItensNew)                         
		nPosTotal:=aScan(aItensNew[nI],{|x| AllTrim(x[1]) == "C8_TOTAL"}) 
		If nPosTotal>0
			aDel(aItensNew[nI],nPosTotal)
			aSize(aitensNew[nI],Len(aItensNew[nI])-1)
		EndIf                                                                   
	Next nI                                        
	aItens:=aClone(aItensNew)
	
	If SC8->( MsSeek( xFilial( "SC8" ) + cCotacao + cFornece + cLoja + cItem + PadR( cProposta, 2 ) ) )
		Mata150( @aCabec, @aItens, 3, , .T. )
	Else
		//Posiciona na cotao do fornecedor e loja
		If SC8->( MsSeek( xFilial( "SC8" ) + cCotacao  + cFornece + cLoja ) )
			While !SC8->( EOF() )	.AND. SC8->C8_NUM == cCotacao ;
				.AND. SC8->C8_FORNECE == cFornece ;
				.AND. SC8->C8_LOJA == cLoja

				cProposta := SC8->C8_NUMPRO
				SC8->( DbSkip() )
      
			EndDo

			aAdd( aCabec, { "C8_NUMPRO", StrZero( Val( cProposta ) + 1, 2 ), Nil } )

			For nI := 1 To Len( aItens )
				aAdd( aItens[nI], { "C8_NUMPRO", StrZero( Val( cProposta ) + 1, 2 ), Nil } )
			Next nI

			Mata150( @aCabec, @aItens, 4, , .T. )
		EndIf
	EndIf

	If lMsErroAuto
		aErro := GetAutoGRLog()
		cErro := ""
		For nI := 1 To Len( aErro )
			cErro += aErro[nI] + Chr( 13 ) + Chr( 10 )
		Next nI

		SetSoapFault( "PUTQUOTE", cErro )
		lRetorno := .F.
	EndIf

	If lRetorno
		aCabec := WsAutoOpc( @aCabec, .F. )

		For nI := 1 To Len( aItens )
			aItens[nI] := WsAutoOpc( @aItens[nI], .T. )
		Next nI

		GetSC8Head( @::NewQuote:QuoteHeader, "SC8", @aCabec )

		For nI := 1 To Len( aItens )
			aadd( ::NewQuote:QuoteItem, WSClassNew( "QuoteItemView" ) )
			dbSelectArea("SC8")
			dbSetOrder(1)
			MsSeek(xFilial("SC8")+WsProcH(aCabec,"C8_NUM")+WsProcH(aCabec,"C8_FORNECE")+WsProcH(aCabec,"C8_LOJA")+WsProcH(aItens[nI],"C8_ITEM")+WsProcH(aItens[nI],"C8_NUMPRO"))		
			GetSC8Item( @::NewQuote:QuoteItem[nI], "SC8", @aItens[nI] )
		Next nI
	EndIf
Else
	lRetorno := .F.
EndIf

RestArea( aArea )

Return( lRetorno )


/*/

Ŀ
Funo    PutSC8HeadAutor   Eduardo Riera          Data 05.12.2003 
Ĵ
          Rotina de preenchimento do Header da cotacao de compra para a
          rotina automatica                                            
Ĵ
ParametrosExpO1: Objeto do Header                                      
          ExpA2: Array com os dados do Cabecalho                       
Ĵ
Retorno   ExpL1:Indica que nao houve erro nos dados enviados           
                                                                       
Ĵ
Descrio Este metodo atualiza a variavel aCab com os dados do objeto  
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
Static Function PutSC8Head(oObjeto,aCab,cCondPag)

Local cFornece := SubStr(oObjeto:Supplier,1,Len(SA2->A2_COD))
Local cLoja    := SubStr(oObjeto:Supplier,Len(SA2->A2_COD)+1)

aadd(aCab,{"C8_NUM",oObjeto:QuoteID,Nil})
aadd(aCab,{"C8_NUMPRO",oObjeto:ProposalID,Nil})
aadd(aCab,{"C8_FORNECE",cFornece,Nil})
aadd(aCab,{"C8_LOJA"   ,cLoja,Nil})
aadd(aCab,{"C8_COND"   ,cCondPag,Nil})
aadd(aCab,{"C8_CONTATO",oObjeto:Contact,Nil})
aadd(aCab,{"C8_EMISSAO",oObjeto:RegisterDate,Nil})
aadd(aCab,{"C8_TOTFRE" ,0,Nil})
aadd(aCab,{"C8_MOEDA"  ,oObjeto:Currency,Nil})
aadd(aCab,{"C8_TXMOEDA",oObjeto:CurrencyRate,Nil})
aadd(aCab,{"C8_DESC1"  ,oObjeto:DiscountInCascade1,Nil})
aadd(aCab,{"C8_DESC2"  ,oObjeto:DiscountInCascade2,Nil})
aadd(aCab,{"C8_DESC3"  ,oObjeto:DiscountInCascade3,Nil})
aadd(aCab,{"C8_MSG",SC8->C8_MSG,Nil})

PutUserFields("SC8",@oObjeto:UserFields,aCab)

Return(.T.)

/*/

Ŀ
Funo    PutSC8ItemAutor   Eduardo Riera          Data 05.12.2003 
Ĵ
          Rotina de preenchimento dos itens da cotacao de compra para a
          rotina automatica                                            
Ĵ
ParametrosExpO1: Objeto do Item                                        
          ExpA2: Array com os dados dos itens                          
Ĵ
Retorno   ExpL1:Indica que nao houve erro nos dados enviados           
                                                                       
Ĵ
Descrio Este metodo atualiza a variavel aitem com os dados do objeto 
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
Static Function PutSC8Item(oObjeto,aItens)

Local nX       := 0
Local nY       := 0
Local nZ       := 0
Local aImposto := {}
Local aLinha   := {}
Local nBase	   := 0
Local nTaxa	   := 0
Local nPBaseIPI := 0		// Posicao do campo C8_BASEIPI no UserFields caso tenha sido incluido via ponto de entrada
Local nPRateICM := 0
Local nPBaseICM := 0		// Posicao do campo C8_BASEICM no UserFields caso tenha sido incluido via ponto de entrada
Local nValBasIPI:= 0
Local nVBaseICM:= 0
Local nVRateICM:= 0
Local lIPI	   := .F.
Local lICM	   := .F.

DEFAULT aItens := {}

For nX := 1 To Len(oObjeto)

	aLinha := {}

	aadd(aLinha,{"C8_ITEM",	oObjeto[nX]:SequentialID,Nil})
	aadd(aLinha,{"C8_NUMPRO",oObjeto[nX]:ProposalID,Nil})
	aadd(aLinha,{"C8_PRODUTO",oObjeto[nX]:ProductCode,Nil})
	aadd(aLinha,{"C8_UM",oObjeto[nX]:MeasureUnit,Nil})
	aadd(aLinha,{"C8_QUANT",oObjeto[nX]:Quantity,Nil})
	aadd(aLinha,{"C8_PRECO",oObjeto[nX]:UnitPrice,Nil})
	aadd(aLinha,{"C8_TOTAL",iif(oObjeto[nX]:TotalValue == 0, (oObjeto[nX]:Quantity*oObjeto[nX]:UnitPrice),oObjeto[nX]:TotalValue),Nil})
	aadd(aLinha,{"C8_DESC",oObjeto[nX]:DiscountPercent,Nil})
	aadd(aLinha,{"C8_VLDESC",oObjeto[nX]:DiscountValue,Nil})
	aadd(aLinha,{"C8_COND",oObjeto[nX]:PaymentPlanCode,Nil})
	aadd(aLinha,{"C8_PRAZO",oObjeto[nX]:DeliveryTermInDays,Nil})
	aadd(aLinha,{"C8_OBS",oObjeto[nX]:Notes,Nil})
	aadd(aLinha,{"C8_VALIDA",oObjeto[nX]:ExpiryDate,Nil})
	aadd(aLinha,{"C8_DATPRF",oObjeto[nX]:DeliveryDate,Nil})
	aadd(aLinha,{"C8_DESPESA",oObjeto[nX]:ExpensesValue,Nil})
	aadd(aLinha,{"C8_SEGURO",oObjeto[nX]:InsuranceValue,Nil})
	aadd(aLinha,{"C8_VALFRE",oObjeto[nX]:FreightValue,Nil})
	aadd(aLinha,{"C8_ALIIPI",oObjeto[nX]:TaxRate,Nil})
	aadd(aLinha,{"C8_FILENT",SC8->C8_FILENT,Nil})
	aadd(aLinha,{cEmpAnt,oObjeto[nX]:Code,Nil})
	aadd(aLinha,{cFilAnt,oObjeto[nX]:Branch,Nil})

	aImposto := MaFisRefLd("SC8")

	If Len(oObjeto[nX]:Taxes) == 0
		oObjeto[nX]:Taxes:={}
	EndIf
	For nY := 1 To Len(oObjeto[nX]:Taxes)
		If oObjeto[nX]:Taxes[nY]:TaxCode $ "IPI"
			lIPI := .T.
		EndIf
		If oObjeto[nX]:Taxes[nY]:TaxCode $ "ICM"
			lICM := .T.
		EndIf
	Next nY

	// Altera a Base IPI caso usuario tenha incluido C8_BASEIPI via ponto de entrada e alterado valor manualmente
	If (nPBaseIPI := aScan(OOBJETO[nX]:USERFIELDS,{|x| x:USERNAME == "C8_BASEIPI"})) > 0
		nValBasIPI := VAL(OOBJETO[nX]:USERFIELDS[nPBaseIPI]:USERTAG)
	EndIf
	// Altera a Base ICM caso usuario tenha incluido C8_BASEICM via ponto de entrada e alterado valor manualmente
	If (nPBaseICM := aScan(OOBJETO[nX]:USERFIELDS,{|x| x:USERNAME == "C8_BASEICM"})) > 0
		nVBaseICM := VAL(OOBJETO[nX]:USERFIELDS[nPBaseICM]:USERTAG)
	EndIf
	// Altera o Rate ICM caso usuario tenha incluido C8_PICM via ponto de entrada e alterado valor manualmente
	If (nPRateICM := aScan(OOBJETO[nX]:USERFIELDS,{|x| AllTrim(x:USERNAME) == "C8_PICM"})) > 0
		nVRateICM := VAL(OOBJETO[nX]:USERFIELDS[nPRateICM]:USERTAG)
	EndIf

	If !lIPI
		aadd(oObjeto[nX]:Taxes,WsClassNew("TaxesView"))
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxCode   := "IPI"
		If nPBaseIPI > 0
			oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase   := nValBasIPI
		Else
			oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase   := oObjeto[nX]:TotalValue
		EndIf
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxRate   := oObjeto[nX]:TaxRate
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxAmount := oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase * ( oObjeto[nX]:TaxRate / 100 )
	EndIf
	
	If !lICM
	aadd(oObjeto[nX]:Taxes,WsClassNew("TaxesView"))
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxCode   := "ICM"
		If nPBaseICM > 0
			oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase   := nVBaseICM
		Else
			oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase   := oObjeto[nX]:TotalValue
		EndIf
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxRate   := oObjeto[nX]:TaxRate
		oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxAmount := oObjeto[nX]:Taxes[Len(oObjeto[nX]:Taxes)]:TaxBase * ( oObjeto[nX]:TaxRate / 100 )
	EndIf

	For nY := 1 To Len(oObjeto[nX]:Taxes)
		nZ := aScan(aImposto,{|x| x[1] == oObjeto[nX]:Taxes[nY]:TaxCode})
		If nZ <> 0
			If oObjeto[nX]:Taxes[nY]:TaxCode $ "IPI"
				If !Empty(aImposto[nZ][2])
					If nPBaseIPI > 0
						nBase := nValBasIPI
					ElseIf oObjeto[nX]:Taxes[nY]:TaxBase <> oObjeto[nX]:TotalValue			// Usurio alterou o preo
						nBase := oObjeto[nX]:TotalValue
					Else
						nBase := oObjeto[nX]:Taxes[nY]:TaxBase
					EndIf
					aadd(aLinha,{aImposto[nZ][2],nBase,Nil})
				EndIf
				If !Empty(aImposto[nZ][3])
					If oObjeto[nX]:Taxes[nY]:TaxRate <> oObjeto[nX]:TaxRate				// Usurio alterou o percentual do IPI
						nTaxa := oObjeto[nX]:TaxRate
					Else
						nTaxa := oObjeto[nX]:Taxes[nY]:TaxRate
					EndIf
					aadd(aLinha,{aImposto[nZ][3],nTaxa,Nil})
					If nTaxa == 0
						aadd(aLinha,{"MANUAL-IPI",.T.,Nil})
					EndIf
				EndIf
				If !Empty(aImposto[nZ][4])
					aadd(aLinha,{aImposto[nZ][4],(nBase * (nTaxa / 100)),Nil})
				EndIf
			ElseIf oObjeto[nX]:Taxes[nY]:TaxCode $ "ICM"
				If !Empty(aImposto[nZ][2])
					If nPBaseICM > 0
						nBase := nVBaseICM
					ElseIf oObjeto[nX]:Taxes[nY]:TaxBase <> oObjeto[nX]:TotalValue			// Usurio alterou o preo
						nBase := oObjeto[nX]:TotalValue
					Else
						nBase := oObjeto[nX]:Taxes[nY]:TaxBase
					EndIf
					aadd(aLinha,{aImposto[nZ][2],nBase,Nil})
				EndIf
				If !Empty(aImposto[nZ][3])
					If  nPRateICM > 0							// Usurio alterou o percentual do ICM
						nTaxa := nVRateICM
					Else
						nTaxa := oObjeto[nX]:Taxes[nY]:TaxRate
					EndIf
					aadd(aLinha,{aImposto[nZ][3],nTaxa,Nil})
					If nTaxa == 0
						aadd(aLinha,{"MANUAL-ICM",.T.,Nil})
					EndIf
				EndIf
				If !Empty(aImposto[nZ][4])
					aadd(aLinha,{aImposto[nZ][4],(nBase * (nTaxa / 100)),Nil})
				EndIf
			Else
				If !Empty(aImposto[nZ][2])
					aadd(aLinha,{aImposto[nZ][2],oObjeto[nX]:Taxes[nY]:TaxBase,Nil})
				EndIf
				If !Empty(aImposto[nZ][3])
					aadd(aLinha,{aImposto[nZ][3],oObjeto[nX]:Taxes[nY]:TaxRate,Nil})
				EndIf
				If !Empty(aImposto[nZ][4])
					aadd(aLinha,{aImposto[nZ][4],oObjeto[nX]:Taxes[nY]:TaxAmount,Nil})
				EndIf
			EndIf
		EndIf
	Next nY

	PutUserFields("SC8",@oObjeto[nX]:UserFields,aLinha)

	aadd(aItens,aLinha)

Next nX

Return(.T.)

/*/

Ŀ
Funo    GetSC8HeadAutor   Eduardo Riera          Data 05.12.2003 
Ĵ
          Rotina de preenchimento do Objeto da cotacao de compra       
                                                                       
Ĵ
ParametrosExpO1: Objeto do Header                                      
          ExpC2: Alias do tabela                                       
          ExpA3: Array com os dados do Cabecalho                       
Ĵ
Retorno   ExpL1:Indica que nao houve erro nos dados enviados           
                                                                       
Ĵ
Descrio Este metodo atualiza a variavel aCab com os dados do objeto  
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
Static Function GetSC8Head(oObjeto,cAliasSC8,aCab)

Local cAliasSAJ := "SAJ"
Local lQuery    := .F.
#IFDEF TOP
Local cQuery    := ""
#ENDIF
If aCab == Nil
	oObjeto:QuoteID            := (cAliasSC8)->C8_NUM
	oObjeto:ProposalID         := (cAliasSC8)->C8_NUMPRO
	oObjeto:Supplier           := (cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA
	oObjeto:RegisterDate       := (cAliasSC8)->C8_EMISSAO
	oObjeto:Contact            := (cAliasSC8)->C8_CONTATO
	oObjeto:PaymentPlanCode	   := (cAliasSC8)->C8_COND
	oObjeto:Currency           := (cAliasSC8)->C8_MOEDA
	oObjeto:CurrencyRate       := (cAliasSC8)->C8_TXMOEDA
	oObjeto:DiscountInCascade1 := (cAliasSC8)->C8_DESC1
	oObjeto:DiscountInCascade2 := (cAliasSC8)->C8_DESC2
	oObjeto:DiscountInCascade3 := (cAliasSC8)->C8_DESC3
	oObjeto:QuoteStatus        := IIf(Empty((cAliasSC8)->C8_NUMPED),STR0008,STR0009)				 //"Aberto"###"Fechado"

	UserFields("SC8",@oObjeto:UserFields,cAliasSC8)

    //..trata os campos MEMO's
	TrataSC8Memo(@oObjeto,cAliasSC8)

	If !Empty((cAliasSC8)->C8_GRUPCOM)
		dbSelectArea("SAJ")
		dbSetOrder(1)
		#IFDEF TOP
			cAliasSAJ := "BrwQuote2"
			lQuery := .T.
			cQuery := "SELECT * "
			cQuery += "FROM "+RetSqlName("SAJ")+" SAJ "
			cQuery += "WHERE SAJ.AJ_FILIAL='"+xFilial("SAJ")+"' AND "
			cQuery += "SAJ.AJ_GRCOM = '"+(cAliasSC8)->C8_GRUPCOM+"' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SAJ->(IndexKey()))

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSAJ)

		#ELSE
			MsSeek(xFilial("SAJ")+(cAliasSC8)->C8_GRUPCOM)
		#ENDIF
		oObjeto:Purchaseres := {}
		While !Eof() .And. xFilial("SAJ") == (cAliasSAJ)->AJ_FILIAL .And.;
			(cAliasSC8)->C8_GRUPCOM == (cAliasSAJ)->AJ_GRCOM

			aadd(oObjeto:Purchaseres,(cAliasSAJ)->AJ_USER)

			dbSelectArea(cAliasSAJ)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSAJ)
			dbCloseArea()
			dbSelectArea("SAJ")
		EndIf
	Else
		oObjeto:Purchaseres := {""}
	EndIf
Else
	oObjeto:QuoteID            := WsProcH(aCab, "C8_NUM")
	oObjeto:ProposalID         := WsProcH(aCab, "C8_NUMPRO")
	oObjeto:Supplier           := WsProcH(aCab, "C8_FORNECE")+WsProcH(aCab, "C8_LOJA")
	oObjeto:RegisterDate       := WsProcH(aCab, "C8_EMISSAO")
	oObjeto:Contact            := WsProcH(aCab, "C8_CONTATO")
	oObjeto:PaymentPlanCode	   := WsProcH(aCab, "C8_COND" )
	oObjeto:Currency           := WsProcH(aCab, "C8_MOEDA")
	oObjeto:CurrencyRate       := WsProcH(aCab, "C8_TXMOEDA")
	oObjeto:DiscountInCascade1 := WsProcH(aCab, "C8_DESC1")
	oObjeto:DiscountInCascade2 := WsProcH(aCab, "C8_DESC2")
	oObjeto:DiscountInCascade3 := WsProcH(aCab, "C8_DESC3")
	oObjeto:QuoteStatus        := IIf(Empty(WsProcH(aCab, "C8_NUMPED")),STR0008,STR0009) //"Aberto"###"Fechado"
	oObjeto:Purchaseres        := {""}

	UserFields("SC8",@oObjeto:UserFields,cAliasSC8,aCab)

EndIf

/*/

Ŀ
Funo    GetSC8ItemAutor   Eduardo Riera          Data 05.12.2003 
Ĵ
          Rotina de preenchimento do Objeto do item da cotacao de      
          compra                                                       
Ĵ
ParametrosExpO1: Objeto do Item                                        
          ExpC2: Alias do tabela                                       
          ExpA3: Array com os dados do Item                            
Ĵ
Retorno   ExpL1:Indica que nao houve erro nos dados enviados           
                                                                       
Ĵ
Descrio Este metodo atualiza a variavel aCab com os dados do objeto  
                                                                       
Ĵ
Uso        CRM/Materiais/Portais                                       
ٱ


/*/
Static Function GetSC8Item(oObjeto,cAliasSC8,aItem)

Local nY        := 0
Local nPBaseIPI := 0		// Posicao do campo C8_BASEIPI no UserFields caso tenha sido incluido via ponto de entrada
Local nPBaseICm := 0		// Posicao do campo C8_BASEICM no UserFields caso tenha sido incluido via ponto de entrada
Local nValBasIPI:= 0
Local nValBasICM:= 0
Local aImpostos := {}
Local nX		:= 1

If aItem == Nil
	oObjeto:SequentialID      := (cAliasSC8)->C8_ITEM
	oObjeto:ProposalID        := (cAliasSC8)->C8_NUMPRO
	oObjeto:ProductCode       := (cAliasSC8)->C8_PRODUTO
	oObjeto:DescriptionProduct:= Posicione("SC1",1,xFilial("SC1")+(cAliasSC8)->C8_NUMSC+(cAliasSC8)->C8_ITEMSC,"C1_DESCRI")
	oObjeto:MeasureUnit       := (cAliasSC8)->C8_UM
	oObjeto:Quantity          := (cAliasSC8)->C8_QUANT
	oObjeto:UnitPrice         := (cAliasSC8)->C8_PRECO
	oObjeto:TotalValue        := (cAliasSC8)->C8_TOTAL
	oObjeto:DiscountPercent   := (cAliasSC8)->C8_DESC
	oObjeto:DiscountValue     := (cAliasSC8)->C8_VLDESC
	oObjeto:PaymentPlanCode   := (cAliasSC8)->C8_COND
	oObjeto:DeliveryTermInDays:= (cAliasSC8)->C8_PRAZO
	oObjeto:Notes             := SC8->C8_OBS
	oObjeto:ExpiryDate        := (cAliasSC8)->C8_VALIDA
	oObjeto:DeliveryDate      := (cAliasSC8)->C8_DATPRF
	oObjeto:ExpensesValue     := (cAliasSC8)->C8_DESPESA
	oObjeto:InsuranceValue    := (cAliasSC8)->C8_SEGURO
	oObjeto:FreightValue      := (cAliasSC8)->C8_VALFRE
	oObjeto:TaxRate           := (cAliasSC8)->C8_ALIIPI
	oObjeto:Code           	  := cEmpAnt
	oObjeto:Branch            := cFilAnt

	aImpostos := MaFisImpLd("SC8","IT",cAliasSC8)
	If len(aImpostos) > 0
		For nY := 1 To Len(aImpostos)
			If nY == 1
				oObjeto:Taxes:={}
			EndIf
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			oObjeto:Taxes[nY]:TaxCode   := aImpostos[nY][1]
			oObjeto:Taxes[nY]:TaxBase   := aImpostos[nY][2]
			oObjeto:Taxes[nY]:TaxRate   := aImpostos[nY][3]
			oObjeto:Taxes[nY]:TaxAmount := aImpostos[nY][4]
		Next nY
	Else
			oObjeto:Taxes:={}
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			oObjeto:Taxes[1]:TaxCode   := "IPI"
			oObjeto:Taxes[1]:TaxBase   := (cAliasSC8)->C8_BASEIPI
			oObjeto:Taxes[1]:TaxRate   := oObjeto:TaxRate
			oObjeto:Taxes[1]:TaxAmount := oObjeto:Taxes[1]:TaxBase * ( oObjeto:Taxes[1]:TaxRate / 100 )
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			oObjeto:Taxes[2]:TaxCode   := "ICM"
			oObjeto:Taxes[2]:TaxBase   := (cAliasSC8)->C8_BASEICM
			oObjeto:Taxes[2]:TaxRate   := oObjeto:TaxRate
			oObjeto:Taxes[2]:TaxAmount := oObjeto:Taxes[1]:TaxBase * ( oObjeto:Taxes[1]:TaxRate / 100 )
	EndIf

	UserFields("SC8",@oObjeto:UserFields,cAliasSC8)

	//..trata os campos MEMO's
	TrataSC8Memo(@oObjeto,cAliasSC8)
	
Else
	oObjeto:SequentialID      := WsProcH(aItem, "C8_ITEM")
	oObjeto:ProposalID        := WsProcH(aItem, "C8_NUMPRO")
	oObjeto:ProductCode       := WsProcH(aItem, "C8_PRODUTO")
	oObjeto:DescriptionProduct:= Posicione("SC1",1,xFilial("SC1")+(cAliasSC8)->C8_NUMSC+(cAliasSC8)->C8_ITEMSC,"C1_DESCRI")
	oObjeto:MeasureUnit       := WsProcH(aItem, "C8_UM")
	oObjeto:Quantity          := WsProcH(aItem, "C8_QUANT")
	oObjeto:UnitPrice         := WsProcH(aItem, "C8_PRECO")
	oObjeto:TotalValue        := WsProcH(aItem, "C8_TOTAL")
	oObjeto:DiscountPercent   := WsProcH(aItem, "C8_DESC")
	oObjeto:DiscountValue     := WsProcH(aItem, "C8_VLDESC")
	oObjeto:PaymentPlanCode	   := WsProcH(aItem, "C8_COND")
	oObjeto:DeliveryTermInDays:= WsProcH(aItem, "C8_PRAZO")
	oObjeto:Notes             := WsProcH(aItem, "C8_OBS")
	oObjeto:ExpiryDate        := WsProcH(aItem, "C8_VALIDA")
	oObjeto:DeliveryDate      := WsProcH(aItem, "C8_DATPRF")
	oObjeto:ExpensesValue     := WsProcH(aItem, "C8_DESPESA")
	oObjeto:InsuranceValue    := WsProcH(aItem, "C8_SEGURO")
	oObjeto:FreightValue      := WsProcH(aItem, "C8_VALFRE")
	oObjeto:TaxRate           := WsProcH(aItem, "C8_ALIIPI") 
	oObjeto:Code              := cEmpAnt
	oObjeto:Branch            := cFilAnt

	UserFields("SC8",@oObjeto:UserFields,cAliasSC8,aItem)

	aImpostos := MaFisImpLd("SC8","IT",cAliasSC8)
	If len(aImpostos) > 0
		For nY := 1 To Len(aImpostos)
			If nY == 1
				oObjeto:Taxes:={}
			EndIf
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			If aImpostos[nY][1] $ "IPI"

				// Altera a Base IPI caso usuario tenha incluido C8_BASEIPI via ponto de entrada e alterado valor manualmente
				If (nPBaseIPI := aScan(OOBJETO:USERFIELDS,{|x| x:USERNAME == "C8_BASEIPI"})) > 0
					nValBasIPI := VAL(OOBJETO:USERFIELDS[nPBaseIPI]:USERTAG)
				EndIf

				oObjeto:Taxes[nY]:TaxCode   := aImpostos[nY][1]
				If nPBaseIPI > 0
					oObjeto:Taxes[nY]:TaxBase	:= nValBasIPI
				ElseIf aImpostos[nY][2] <> oObjeto:TotalValue				// Usurio alterou o preo
					oObjeto:Taxes[nY]:TaxBase   := oObjeto:TotalValue
				Else
					oObjeto:Taxes[nY]:TaxBase   := aImpostos[nY][2]
				EndIf
				If aImpostos[nY][3] <> oObjeto:TaxRate					// Usurio alterou o percentual do IPI
					oObjeto:Taxes[nY]:TaxRate   := oObjeto:TaxRate
				Else
					oObjeto:Taxes[nY]:TaxRate   := aImpostos[nY][3]
				EndIf
				oObjeto:Taxes[nY]:TaxAmount := ( oObjeto:Taxes[nY]:TaxBase * ( oObjeto:Taxes[nY]:TaxRate / 100 ))
			ElseIf aImpostos[nY][1] $ "ICM"
				// Altera a Base IPI caso usuario tenha incluido C8_BASECM via ponto de entrada e alterado valor manualmente
				If (nPBaseICM := aScan(OOBJETO:USERFIELDS,{|x| x:USERNAME == "C8_BASEICM"})) > 0
					nValBasICM := VAL(OOBJETO:USERFIELDS[nPBaseICM]:USERTAG)
				EndIf

				oObjeto:Taxes[nY]:TaxCode   := aImpostos[nY][1]
				If nPBaseICM > 0
					oObjeto:Taxes[nY]:TaxBase	:= nValBasICM
				ElseIf aImpostos[nY][2] <> oObjeto:TotalValue				// Usurio alterou o preo
					oObjeto:Taxes[nY]:TaxBase   := oObjeto:TotalValue
				Else
					oObjeto:Taxes[nY]:TaxBase   := aImpostos[nY][2]
				EndIf
				If aImpostos[nY][3] <> oObjeto:TaxRate					// Usurio alterou o percentual do ICM
					oObjeto:Taxes[nY]:TaxRate   := oObjeto:TaxRate
				Else
					oObjeto:Taxes[nY]:TaxRate   := aImpostos[nY][3]
				EndIf
				oObjeto:Taxes[nY]:TaxAmount := ( oObjeto:Taxes[nY]:TaxBase * ( oObjeto:Taxes[nY]:TaxRate / 100 ))
			Else
				oObjeto:Taxes[nY]:TaxCode   := aImpostos[nY][1]
				oObjeto:Taxes[nY]:TaxBase   := aImpostos[nY][2]
				oObjeto:Taxes[nY]:TaxRate   := aImpostos[nY][3]
				oObjeto:Taxes[nY]:TaxAmount := aImpostos[nY][4]
			EndIf
		Next nY
	EndIf			
	If Len(aImpostos)== 0
		oObjeto:Taxes:={}	
	EndIf	
	If Len(aImpostos) == 0 .Or. aScan(aImpostos,{|x| AllTrim(x[1])=="IPI"}) == 0
		If oObjeto:TaxRate > 0			
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			oObjeto:Taxes[nX]:TaxCode   := "IPI"
			If WsProcH(aItem, "C8_BASEIPI") <> oObjeto:TotalValue		// Usurio alterou o preo
				oObjeto:Taxes[nX]:TaxBase   := oObjeto:TotalValue
			Else
				oObjeto:Taxes[nX]:TaxBase   := WsProcH(aItem, "C8_BASEIPI")
			EndIf
			oObjeto:Taxes[nX]:TaxRate   := oObjeto:TaxRate
			oObjeto:Taxes[nX]:TaxAmount := oObjeto:Taxes[nX]:TaxBase * ( oObjeto:Taxes[nX]:TaxRate / 100 )
			nX++
		EndIf		
	EndIf
	If Len(aImpostos) == 0 .Or. aScan(aImpostos,{|x| AllTrim(x[1])=="ICM"}) == 0		
		If oObjeto:TaxRate > 0			
			aadd(oObjeto:Taxes,WsClassNew("TaxesView"))
			oObjeto:Taxes[nX]:TaxCode   := "ICM"
			If WsProcH(aItem, "C8_BASEICM") <> oObjeto:TotalValue		// Usurio alterou o preo
				oObjeto:Taxes[nX]:TaxBase   := oObjeto:TotalValue
			Else
				oObjeto:Taxes[nX]:TaxBase   := WsProcH(aItem, "C8_BASEICM")
			EndIf
			oObjeto:Taxes[nX]:TaxRate   := oObjeto:TaxRate
			oObjeto:Taxes[nX]:TaxAmount := oObjeto:Taxes[nX]:TaxBase * ( oObjeto:Taxes[nX]:TaxRate / 100 )
		EndIf		
	EndIf
EndIf
	
Return(.T.)
        
/*


Ŀ
Funo    TrataSC8Memo  Autor  Moises Nunes      Data  12/08/2011 
Ĵ
Descrio Trata os campos IMAGE,BLOB do banco de Dados que foram      
          criados no configurador como Tipo:MEMO Contexto:REAL        
          -Sem o uso dessa funo o contedo do campo  exibido       
           criptografado    										  
Ĵ


*/
Function TrataSC8Memo(oObjeto,cAlias)
    
Local i:=0     
Local nRecSC8   := 0
Local cCampoSC8 := ""
        
If oObjeto:UserFields != Nil
	For i:=1 to len(oObjeto:UserFields)    
		If oObjeto:UserFields[i]:UserType=="M"
			nRecSC8:= (cAlias)->R_E_C_N_O_
			cCampoSC8:=oObjeto:UserFields[i]:UserName
			
			SC8->(dbgoto(nRecSC8))
			oObjeto:UserFields[i]:UserTag:=SC8->&cCampoSC8
		EndIf
	Next i
EndIf

Return 
 